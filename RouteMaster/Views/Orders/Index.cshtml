@model IEnumerable<RouteMaster.Models.ViewModels.OrderIndexVM>
@section Styles
    {

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap4.min.css">

    <style>
        thead {
            background-color: gainsboro;
            color: white;
        }

    </style>
}


@{
    ViewBag.Title = "Index";
    var paymentStatus = ViewBag.paymentStatus as SelectList;
    var criteria = ViewBag.Criteria as RouteMaster.Models.Infra.Criterias.OrderCriteria;
    string s_paymentstatus = criteria.PaymentStatus.HasValue ? criteria.PaymentStatus.Value.ToString() : "";
}
<h2>訂單管理</h2>

<p>
    @*@Html.ActionLink("Create New", "Create")*@
    <button id="exportButton" class="btn btn-primary" onclick="exportExcel()">匯出Excel</button>
    <button id="sendEmailButton" class="btn btn-primary">一鍵通知</button>
</p>
<section class="container">
    <form method="get">
        <div class="row">
            <div class="mb-2 col-md-3">
                <label for="MemberName">訂購人</label>
                <input type="text" class="form-control" name="membername" id="MemberName" value="@criteria.MemberName" />
            </div>

            <div class="mb-2 col-md-2">
                <label for="s_PaymentStatus">付款狀態</label>
                <select name="paymentStatus" id="s_PaymentStatus" class="form-select">
                    @foreach (var item in paymentStatus)
                    {
                        <option value="@item.Value" @(s_paymentstatus == item.Value ? "selected" : "")>@item.Text</option>
                    }
                </select>
            </div>
            <div class="mb-3 col-md-4">
                <label for="s_CreateDate" style="display: block">訂購日期</label>
                <input type="date" class="form-control" name="CreateStartDate" id="s_CreateStartDate" style="width: 40%; display: inline" value="@criteria.CreateStartDate"> ~
                <input type="date" class="form-control" name="CreateEndDate" id="s_CreateEndDate" style="width: 40%; display: inline" value="@criteria.CreateEndDate">
            </div>


            <div class="mb-3 col-md-2 align-self-end">
                <button class="btn btn-primary">搜尋</button>
            </div>

        </div>
    </form>

</section>

<!--<table id="orderTable" class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Id</th>
            <th>MemberName</th>
            <th>PaymentMethodName</th>
            <th>CreateDate</th>
            <th>Total</th>
            <th>PaymentStatusText</th>
        </tr>
    </thead>
    <tbody>-->
<!-- 数据行 -->
<!--</tbody>
</table>-->

<table id="orderTable" class="table table-striped table-hover dt-responsive" style="width:100%">
    <thead>
        <tr style="text-align: center" ;>
            <th>@Html.DisplayNameFor(model => model.Id)</th>
            <th>@Html.DisplayNameFor(model => model.MemberName)</th>
            <th>@Html.DisplayNameFor(model => model.MemberEmail)</th>
            <th>@Html.DisplayNameFor(model => model.PaymentMethodName)</th>
            <th>@Html.DisplayNameFor(model => model.CreateDate)</th>
            <th>@Html.DisplayNameFor(model => model.Total)</th>
            <th>@Html.DisplayNameFor(model => model.PaymentStatus)</th>
            <th>管理</th>
            <th><input type="checkbox" id="checkAll" /></th>
        </tr>



        <!--<tr>

        <th class="control-label col-md-1" style="text-align: center;">
            @Html.DisplayNameFor(model => model.Id)
        </th>-->
        @*<th>
                @Html.DisplayNameFor(model => model.MemberId)
            </th>*@

        <!--<th class="control-label col-md-2" style="text-align: center;">
            @Html.DisplayNameFor(model => model.MemberName)
        </th>-->
        @Html.DisplayNameFor(model => model.MemberEmail)
        @*<th>
                @Html.DisplayNameFor(model => model.PaymentMethodId)
            </th>*@
        <!--<th class="control-label col-md-2" style="text-align: center;">
                @Html.DisplayNameFor(model => model.PaymentMethodName)
            </th>
            <th class="control-label col-md-3" style="text-align: center;">
                @Html.DisplayNameFor(model => model.CreateDate)
            </th>
            <th class="control-label col-md-1" style="text-align: center;">
                @Html.DisplayNameFor(model => model.Total)
            </th>
            <th class="control-label col-md-1" style="text-align: center;">
                @Html.DisplayNameFor(model => model.PaymentStatus)
            </th>
            <th></th>
        </tr>-->
    </thead>

    <tbody>

        @foreach (var item in Model)
        {

            <tr>
                <td class="control-label col-md-1" style="text-align: center;">
                    @Html.DisplayFor(modelItem => item.Id)
                </td>
                @*<td>
                        @Html.DisplayFor(modelItem => item.MemberId)
                    </td>*@
                <td class="control-label col-md-1" style="text-align: center;">
                    @Html.DisplayFor(modelItem => item.MemberName)
                </td>
                @*<td>
                        @Html.DisplayFor(modelItem => item.PaymentMethodId)
                    </td>*@
                <td class="control-label col-md-2" style="text-align: center;">
                    @Html.DisplayFor(modelItem => item.MemberEmail)
                </td>
                <td class="control-label col-md-2" style="text-align: center;">
                    @Html.DisplayFor(modelItem => item.PaymentMethodName)

                </td>


                <td class="control-label col-md-2" style="text-align: center;">
                    @Html.DisplayFor(modelItem => item.CreateDate)
                </td>
                @*<td class="control-label col-md-1" style="text-align: center;">
                        @Html.DisplayFor(modelItem => item.Total)
                    </td>*@
                <td class="control-label col-md-2" style="text-align: center" id="totalPrice" data-itemid="@item.Id">
                    <span id="TotalOrderPrice_@item.Id"> @Html.DisplayFor(modelItem => item.Total)</span>
                </td>

                <td class="control-label col-md-2" style="text-align: center;">
                    @Html.DisplayFor(modelItem => item.PaymentStatusText)
                </td>
                @*<td class="control-label col-md-2" style="text-align:center;">
                        <div class="row">
                            <div class="col-6">
                                <select class="form-control" name="PaymentStatus">
                                    <option value="1">已付款</option>
                                    <option value="2">未付款</option>
                                    <option value="3">已取消</option>
                                </select>
                                <input type="hidden" name="PaymentStatusText" value="@item.PaymentStatusText" />
                            </div>
                            <div class="col-6">
                                <button id="changePaymentStatus" class="btn btn-primary">更改</button>
                            </div>
                        </div>
                    </td>*@
            <td>
                @Html.ActionLink("Edit", "Edit", new { id = item.Id })
                @Html.ActionLink("Details", "Details", new { id = item.Id }, new { @class = "btn btn-light" })
                @*@Html.ActionLink("Delete", "Delete", new { id = item.Id })*@
            </td>
                <td><input type="checkbox" id="getValues" name="selectedOrderIds" value="@item.Id" /></td>

            </tr>
        }
    </tbody>
    @*<tfoot>
            <tr>
                <th>Id</th>
                <th>MemberName</th>
                <th>PaymentMethodName</th>
                <th>CreateDate</th>
                <th>Total</th>
                <th>PaymentStatusText</th>
            </tr>
        </tfoot>*@

</table>


@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        document.getElementById("checkAll").addEventListener("click", function () {
            var checkboxesall = document.querySelectorAll("input[type=checkbox]");
            for (var i = 0; i < checkboxesall.length; i++) {
                checkboxesall[i].checked = this.checked;
                console.log(checkboxesall);
            }

        });



    </script>
    <script>

        //document.getElementById("getValue").addEventListener("click", function () {
        //    var selectedValues = [];
        //    var checkboxes = document.querySelectorAll("input[name=check]");
        //    for (var i = 0; i < checkboxes.length; i++) {
        //        if (checkboxes[i].checked) {
        //            selectedValues.push(checkboxes[i].value);
        //            console.log(selectedValues);
        //        }
        //    }

        //});
    </script>

    <script>
        new DataTable('#orderTable', {
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Chinese-traditional.json'
            },
            responsive: true
        });
    </script>

    <script>
        const generateExcel = (data) => {

            const csvContent = "data:text/csv;charset=utf-8," + data.map(row => Object.values(row).join(",")).join("\n");

            const downloadLink = document.createElement("a");
            downloadLink.href = encodeURI(csvContent);
            downloadLink.download = "data.csv";

            downloadLink.click();
        };

        const exportExcel = () => {
            let list = [];


            const table = document.getElementById("orderTable");
            const tbody = table.getElementsByTagName("tbody")[0];
            const rows = tbody.getElementsByTagName("tr");

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName("td");


                const obj = {
                    Id: cells[0].innerText,
                    MemberName: cells[1].innerText,
                    PaymentMethodName: cells[2].innerText,
                    CreateDate: cells[3].innerText,
                    Total: cells[4].innerText,
                    PaymentStatusText: cells[5].innerText,
                };


                list.push(obj);
            }
            /*console.log(list);*/

            generateExcel(list);

        };
    </script>
    <script>

        $(document).ready(function () {
            $("#sendEmailButton").click(function () {
                var selectedOrderIds = [];


                $("input[name='selectedOrderIds']:checked").each(function () {
                    selectedOrderIds.push(parseInt($(this).val()));
                });

                $.ajax({
                    url: "https://localhost:44371/Orders/SendUnpaidNotification",
                    method: "POST",
                    data: { selectedOrderIds: selectedOrderIds },
                    success: function (data) {
                        /*console.log(data);*/
                        alert("已成功通知!");
                    },
                    error: function (error) {
                        /*console.log(error);*/
                        alert("信件無法發送，請再試一次!");
                    }
                });
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            $("#changePaymentStatus").click(function () {

                var paymentStatus = $("select[name='paymentStatus']").val();

            });

            $.ajax({
                url: "https://localhost:44371/Orders/UpdatePaymentStatus",
                method: "Post",
                data: { paymentStatus: paymentStatus, paymentStatusText: $("input[name='PaymentStatusText']").val() },
                success: function (data) {
                    console.log(data);
                    alert("已成功更改!");
                },
                error: function (error) {
                    alert("無法修改");
                }



            });

        });

    </script>

    <script>
        $(document).ready(function () {
            $("#changePaymentMethod").click(function () {

                var paymentStatus = $("select[name='paymentStatus']").val();

            });

            $.ajax({
                url: "https://localhost:44371/Orders/UpdatePaymentStatus",
                method: "Post",
                data: { paymentStatus: paymentStatus, paymentStatusText: $("input[name='PaymentStatusText']").val() },
                success: function (data) {
                    console.log(data);
                    alert("已成功更改!");
                },
                error: function (error) {
                    alert("無法修改");
                }



            });

        });

    </script>

}

